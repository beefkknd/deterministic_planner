 New Issues Found

  CRITICAL

  #21 — InputRef validation silently drops invalid refs → sub-goal runs with wrong/missing inputs
  File: f02_deterministic_planner.py:268-277

  if from_id not in valid_ids:
      continue    # ← silently drops the input

  if from_id in existing_outputs:
      if slot not in existing_outputs[from_id]:
          continue    # ← silently drops the input

  When an invalid InputRef is dropped, the sub-goal loses that input dependency. Two bad outcomes:

  Scenario A: Sub-goal has 2 inputs, 1 is invalid. The invalid one is dropped. Sub-goal now has 1 input. It dispatches with only partial data. Worker gets some
  resolved_inputs but not all → confusing partial execution or wrong results.

  Scenario B: Sub-goal has 1 input, it's invalid. Input is dropped entirely. Sub-goal now has inputs: {} — no dependencies. _is_sub_goal_ready returns True immediately.
  Worker runs without the data it needs → fails with "No X provided" error. Wastes a round.

  Both are worse than failing upfront because they waste a round, produce confusing errors, and F02 has to figure out what went wrong.

  Fix options:

  Option A — Fail the sub-goal at creation time (recommended):
  # If any InputRef is invalid, mark the whole sub-goal as failed
  # Don't add it to state — return it with status="failed" so F02
  # sees it in failed_context next round
  if from_id not in valid_ids:
      sg["status"] = "failed"
      sg["error"] = f"Invalid InputRef: sub_goal {from_id} does not exist"
      break

  Option B — Keep the invalid ref intact, let it stay pending forever:
  Don't validate at all in _convert_planned_sub_goals. The sub-goal keeps the bad InputRef. _is_sub_goal_ready will never find it in completed_outputs. The sub-goal
  stays pending. F02 sees it in pending_context and eventually gives up or the round budget runs out.

  Downside: wastes rounds waiting. But no wrong execution.

  Option C — Log a warning and drop the entire sub-goal (simplest):
  If any InputRef fails validation, don't add that sub-goal to the list at all. F02 won't see it in any context (not completed, not failed, not pending) — but with the
  pending context fix, that's fine; F02 just doesn't see a response for something it asked for and can re-plan.

  I'd recommend Option A — fail the sub-goal explicitly so F02 sees the error and can decide what to do.

  ---
  HIGH

  #22 — PLANNER_SYSTEM_PROMPT missing rule about pending sub-goals
  File: f02_deterministic_planner.py:76-110

  The template now shows {pending_context} — good. But the system prompt has no rule telling F02 what to do with this information. Rules 1-7 don't mention pending
  sub-goals at all.

  Without explicit instruction, the LLM might:
  - Ignore the pending section entirely
  - Create duplicates anyway ("I'll create a better version")
  - Get confused about which IDs to reference

  Need to add a Rule 8:

  8. PENDING SUB-GOALS: Sub-goals listed as "pending" were already created \
  in a previous round but are waiting for their input dependencies to be \
  satisfied. Do NOT create new sub-goals that duplicate pending ones. \
  They will be dispatched automatically once their dependencies are met. \
  Only create new sub-goals for work that is NOT already covered by \
  pending sub-goals.


  #23 — synthesis_inputs InputRefs are NOT validated
  File: f02_deterministic_planner.py:397-403

  When F02 returns action="done", it provides synthesis_inputs with InputRefs pointing to completed sub-goals. These refs are NOT validated:

  synthesis_inputs: dict[str, InputRef] = {
      name: {
          "from_sub_goal": ref.from_sub_goal,
          "slot": ref.slot,
      }
      for name, ref in decision.synthesis_inputs.items()
  }

  If the LLM hallucinates a bad from_sub_goal or slot, F14 produces [Missing output: X from sub_goal 99] in the final response — visible to the user.

  Same validation logic should apply here. Since these should ALL point to completed sub-goals, validation is even simpler:

  # Validate: all synthesis_inputs must reference completed sub-goals
  completed = state.get("completed_outputs", {})
  for name, ref in decision.synthesis_inputs.items():
      from_id = ref.from_sub_goal
      slot = ref.slot
      if from_id not in completed or slot not in completed[from_id]:
          # Bad ref — fall back to F14's deliverable collection fallback
          synthesis_inputs = {}
          break

  ---
  MEDIUM

  #24 — F04 still uses old resolved.get("question") pattern
  File: f04_common_helpdesk.py:124-127

  question = worker_input.get("resolved_inputs", {}).get(
      "question",
      sub_goal.get("description", "")
  )

  All other workers (F05, F06, F09, F10, F12) were updated to sub_goal.get("description", "") directly. F04 was missed. Not broken — the fallback works — but
  inconsistent.

  ---
  Everything Else: Clean

  - state.py: Clean. Custom reducer, no unused imports/enums, "running" removed.
  - graph.py: Topology correct. Conditional edges, Send() pattern, loop-back all sound.
  - F01: Clean. Structured output, history handling, immutable return.
  - F03: Clean. WORKER_MAP complete (all 9), error wrapping correct.
  - F07: Returns raw ES dict — compatible with F11 and F12.
  - F08: Pagination logic correct, uses params for offset/limit.
  - F11: Handles both dict and list shapes for es_results.
  - F13: Immutable state update, stores in completed_outputs, clears worker_results.
  - F14: synthesis_inputs resolution + deliverable fallback both work.
  - worker_registry.py: @worker_tool decorator clean.
  - init.py: Only imports graph (single import path for workers).
  - Async patterns: All correct — no sync/async mismatch.
  - Fan-out/Join: Correct — Send() → reducer concat → F13 join → F02 loop.

  ---
  Summary

  ┌─────┬──────────┬──────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────┐
  │  #  │ Severity │                          Issue                           │                      Fix effort                      │
  ├─────┼──────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ #21 │ CRITICAL │ Silent InputRef drop → sub-goal runs with missing inputs │ Small — change continue to fail-the-sub-goal         │
  ├─────┼──────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ #22 │ HIGH     │ System prompt has no rule about pending sub-goals        │ Small — add Rule 8 to system prompt                  │
  ├─────┼──────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ #23 │ HIGH     │ synthesis_inputs InputRefs not validated                 │ Small — add validation before returning "done" state │
  ├─────┼──────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ #24 │ MEDIUM   │ F04 still uses old resolved.get("question") pattern      │ Trivial                                              │
  └─────┴──────────┴──────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────┘